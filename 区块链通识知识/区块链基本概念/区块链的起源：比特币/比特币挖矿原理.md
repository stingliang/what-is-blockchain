<!-- 
It is written by liangrui_ibilling,
email:liangrui_ibilling@si-tech.com
-->

## 比特币挖矿原理

比特币系统中挖矿只是一个形象的概念。比特币系统是一个参与节点互相验证的公开记账系统，而比特币挖矿的本质则是争夺某一个区块的记账权。

“挖矿”成功既是该节点成功获得当前区块的记账权，其他节点会同步该节点挖矿成功的当前区块，并执行和验证。获得记账权的节点会获取一定数量的比特币奖励，以此激励比特币网络中的所有节点积极参与记账工作。

该奖励包含**系统奖励**和**交易手续费**两部分，系统奖励则作为比特币发行的手段。最初每生产一个“交易记录区块”可以获得50比特币的系统奖励，为控制比特币发行数量，该奖励每4年就会减半，到2140年即会基本发放完毕，最终整个系统中最多只能有2100万个比特币。

比特币系统大约每10分钟会记录一个数据块，这个数据块里包含了这10分钟内全网待确认的部分或全部交易。所谓的“挖矿”，就是争夺将这些交易打包成“交易记录区块”的权利。比特币系统会随机生成一道数学难题，后续会详细描述该数学难题，所有参与挖矿的节点一起参与计算这道数学难题，首先算出结果的节点将获得记账权。

每个节点会将过去一段时间内发生的、尚未经过网络公认的交易信息进行收集、检验、确认，最后打包并加签名为一个无法被篡改的“交易记录区块”，并在获得记账权后将该区块进行广播，从而让这个区块被全部节点认可，让区块中的交易成为比特币网络上公认已经完成的交易记录，永久保存。

### 挖矿原理

比特币中每个区块生成时，需要把上一个区块的**哈希值**、本区块的交易信息的默克尔树根、一个未知的随机数（nonce）拼在一起计算一个新的哈希值。为了保证10分钟产生一个区块，该工作必须具有一定难度，即哈希值必须以若干个0开头。哈希算法中，输入信息的任何微小改动即可引起哈希值的巨大变动，且这个变动不具有规律性。因为哈希值的位数是有限的，通过不断尝试随机数nonce，总可以计算出一个符合要求的哈希值，且该随机数无法通过寻找规律计算出来。这意味着，该随机数只能通过暴力枚举的方式获得。挖矿中计算数学难题即为寻找该随机数的过程。

> **哈希算法（Hash）**
>
> 概括来说，就是把任意长度的输入值通过一定的计算，生成一个固定长度的字符串，输出的字符串即为该输入的哈希值。比特币系统中采用SHA-256算法，该算法最终输出的哈希值长度为256 bit。

哈希值由16进制数字表示，即每一位有16种可能。根据哈希算法的特性，出现任何一个数字的概率是均等的，即每一位为“0”的概率为1/16。要求某一位为“0”平均需要16次哈希运算，要求前n位为“0”，则需要进行哈希计算的平均次数为16的n次方。矿工为了计算出该随机数，需要花费一定的时间进行大量的哈希运算。

> 举例
>
> 若某个区块的数学难题的前n位为0，则最坏情况下需要进行$16^n$哈希计算

某个矿工成功计算出该随机数后，则会进行区块打包并全网广播。其他节点收到广播后，只需对包含随机数的区块按照同样的方法进行一次哈希运算即可，若哈希值以“0”开头的个数满足要求，且通过其他合法性校验，则接受这个区块，并停止本地对当前区块随机数的寻找，开始下个区块随机数的计算。

随着技术的发展，进行一次哈希计算速度越来越快，同时随着矿工的逐渐增多，算出满足哈希值以一定数量“0”开头的随机数的时间越来越短。为保证比特币始终按照平均每10分钟一个区块的速度出块，必须不断调整计算出随机哈希计算的平均次数，即调整哈希值以“0”开头的数量要求，以此调整难度。比特币中，每生成2016个区块就会调整一次难度，即调整周期大约为两周（2016×10min=14天）。也就是说，对比生成最新2016个区块花费的实际时间和按照每10分钟出一个块生成2016个块的期望时间，若实际时间大于期望时间则降低难度，若实际时间小于期望时间则增加难度。

![bitcoinBlock](https://github-1302606429.cos.ap-chengdu.myqcloud.com/blockchain/images/bitcoin/bitcoinBlock.png)

从图中可以看到，挖到本区块的节点将收到6.25个比特币和本区块中所有交易的手续费作为奖励。根据2021/1/3的BTC价格，该节点可以获得等价于207,543美元的挖矿奖励。

#### 矿池

随着区块链的日渐火爆，参与挖矿的人越来越多，按照比特币原本的设计模式，只有成功打包一个区块的人才能获取奖励。如果每个矿工都独立挖矿，在如此庞大的基数下，挖矿成功的概率几乎为0，只有一个幸运儿可以获取一大笔财富，其他矿工投入的算力、电力资源就会白白亏损。或许投入一台矿机，持续挖矿好几年甚至更久才能挖到一个区块。

为了降低这种不确定性，矿池应运而生。假如有10万矿工参与挖矿工作，这10万矿工的算力和占这个网络的10%，则这10万个矿工中的某个矿工成功挖到下个块的概率即为1/10。即平均每个矿工成功挖到下个区块的概率为1/1000000，即平均每个矿工要花费19年可以成功挖到一个区块，然后获得相应的比特币奖励。这种挖矿模式风险过大，几乎没人可以承受。但是假设这10万个矿工共同协作参与挖矿，则平均每100分钟即可成功挖到一个区块，然后按照每个矿工提供的算力分配该次收益。这10万个矿工的收益也会趋于稳定。